"use client";

import { useEffect, useRef, useState } from "react";
import { EditorContent, useEditor } from "@tiptap/react";
import StarterKit from "@tiptap/starter-kit";
import Placeholder from "@tiptap/extension-placeholder";
import type { JSONContent } from "@tiptap/core";

type Chapter = {
  id: string;
  title: string;
  content: JSONContent;
};

type Message = { id: string; role: "user" | "assistant"; content: string };

const CHAPTER_STORAGE_KEY = "ai_writer_chapters";
const ACTIVE_CHAPTER_KEY = "ai_writer_active";

const createInitialContent = (title: string): JSONContent => ({
  type: "doc",
  content: [
    {
      type: "heading",
      attrs: { level: 1 },
      content: [{ type: "text", text: title }],
    },
    {
      type: "paragraph",
      content: [
        {
          type: "text",
          text: "å¼€å§‹å†™ä½œï¼Œæ‰€æœ‰å†…å®¹éƒ½ä¼šä»¥ JSON æ ¼å¼ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€?,
        },
      ],
    },
  ],
});

const createDefaultChapters = (): Chapter[] => [
  { id: "chapter-intro", title: "å¼•è¨€", content: createInitialContent("å¼•è¨€") },
  { id: "chapter-1", title: "ç¬¬ä¸€ç«?, content: createInitialContent("ç¬¬ä¸€ç«?) },
  { id: "chapter-2", title: "ç¬¬äºŒç«?, content: createInitialContent("ç¬¬äºŒç«?) },
];

const createChapterId = () => {
  if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
    return crypto.randomUUID();
  }
  return `chapter-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
};

export default function Home() {
  const defaultChaptersRef = useRef<Chapter[]>(createDefaultChapters());
  const [chapters, setChapters] = useState<Chapter[]>(defaultChaptersRef.current);
  const [activeChapterId, setActiveChapterId] = useState<string>(
    defaultChaptersRef.current[0]?.id ?? ""
  );
  const [isInitialized, setIsInitialized] = useState(false);
  const activeChapterRef = useRef(activeChapterId);

  const [messages, setMessages] = useState<Message[]>([
    {
      id: "m1",
      role: "assistant",
      content: "æ¬¢è¿ä½¿ç”¨ AI å†™ä½œç•Œé¢ã€‚æ‰€æœ‰ç« èŠ‚å†…å®¹å°†å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆä»… UIï¼‰ã€?,
    },
  ]);
  const [input, setInput] = useState("");

  const editor = useEditor(
    {
      extensions: [
        StarterKit,
        Placeholder.configure({ placeholder: "å¼€å§‹å†™ä½œâ€? }),
      ],
      content: defaultChaptersRef.current[0]?.content ?? createInitialContent("AI å†™ä½œé¡¹ç›®"),
      autofocus: true,
      immediatelyRender: false,
      editorProps: {
        attributes: {
          class: "tiptap prose max-w-none focus:outline-none",
        },
      },
      onUpdate: ({ editor }) => {
        const currentId = activeChapterRef.current;
        if (!currentId) return;
        const json = editor.getJSON();
        setChapters((prev) =>
          prev.map((chapter) =>
            chapter.id === currentId ? { ...chapter, content: json } : chapter
          )
        );
      },
    },
    []
  );

  useEffect(() => {
    activeChapterRef.current = activeChapterId;
  }, [activeChapterId]);

  useEffect(() => {
    if (typeof window === "undefined") return;

    try {
      const storedChapters = window.localStorage.getItem(CHAPTER_STORAGE_KEY);
      const storedActiveId = window.localStorage.getItem(ACTIVE_CHAPTER_KEY);

      if (storedChapters) {
        const parsed: unknown = JSON.parse(storedChapters);
        if (Array.isArray(parsed) && parsed.length > 0) {
          const valid = parsed.every((item) =>
            typeof item === "object" &&
            item !== null &&
            "id" in item &&
            "title" in item &&
            "content" in item
          );
          if (valid) {
            setChapters(parsed as Chapter[]);
            if (
              storedActiveId &&
              (parsed as Chapter[]).some((chapter) => chapter.id === storedActiveId)
            ) {
              setActiveChapterId(storedActiveId);
            } else {
              setActiveChapterId((parsed as Chapter[])[0]?.id ?? "");
            }
            setIsInitialized(true);
            return;
          }
        }
      }
    } catch (error) {
      console.error("è¯»å–ç« èŠ‚æ•°æ®å¤±è´¥", error);
    }

    setIsInitialized(true);
  }, []);

  useEffect(() => {
    if (!isInitialized) return;
    if (typeof window === "undefined") return;
    window.localStorage.setItem(CHAPTER_STORAGE_KEY, JSON.stringify(chapters));
  }, [chapters, isInitialized]);

  useEffect(() => {
    if (!isInitialized) return;
    if (typeof window === "undefined") return;
    window.localStorage.setItem(ACTIVE_CHAPTER_KEY, activeChapterId);
  }, [activeChapterId, isInitialized]);

  useEffect(() => {
    if (!isInitialized) return;
    if (!editor) return;
    const current = chapters.find((chapter) => chapter.id === activeChapterId);
    if (current) {
      editor.commands.setContent(current.content, false);
    } else {
      editor.commands.clearContent(true);
    }
  }, [editor, activeChapterId, chapters, isInitialized]);

  const addChapter = () => {
    const index = chapters.length + 1;
    const title = `æ–°ç« èŠ?${index}`;
    const chapter: Chapter = {
      id: createChapterId(),
      title,
      content: createInitialContent(title),
    };
    setChapters((prev) => [...prev, chapter]);
    setActiveChapterId(chapter.id);
  };

  const renameChapter = (chapter: Chapter) => {
    const nextTitle = window.prompt("è¯·è¾“å…¥æ–°çš„ç« èŠ‚æ ‡é¢?, chapter.title);
    if (!nextTitle) return;
    const trimmed = nextTitle.trim();
    if (!trimmed) return;
    setChapters((prev) =>
      prev.map((item) =>
        item.id === chapter.id ? { ...item, title: trimmed } : item
      )
    );
  };

  const removeChapter = (chapter: Chapter) => {
    if (chapters.length <= 1) {
      window.alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç« èŠ‚ã€?);
      return;
    }
    const confirmed = window.confirm(`ç¡®è®¤åˆ é™¤â€?{chapter.title}â€å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`);
    if (!confirmed) return;
    setChapters((prev) => {
      const filtered = prev.filter((item) => item.id !== chapter.id);
      if (filtered.length > 0 && chapter.id === activeChapterRef.current) {
        const fallback = filtered[filtered.length - 1];
        setActiveChapterId(fallback.id);
      }
      return filtered;
    });
  };

  const onSend = (event: React.FormEvent) => {
    event.preventDefault();
    if (!input.trim()) return;
    const userMsg: Message = {
      id: `m${Date.now()}`,
      role: "user",
      content: input.trim(),
    };
    setMessages((prev) => [...prev, userMsg]);
    setInput("");
  };

  return (
    <div className="h-screen w-full flex bg-primary">
      <aside className="hidden md:flex md:w-64 lg:w-72 xl:w-80 border-r border-light bg-primary flex-col">
        <div className="px-4 py-3 border-b border-light flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: "var(--color-dark)" }}>
              <span className="text-white font-bold text-sm">AI</span>
            </div>
            <span className="text-primary font-semibold">å†™ä½œé¡¹ç›®</span>
          </div>
          <button onClick={addChapter} className="btn-secondary px-3 py-2 text-sm">
            æ–°ç« èŠ?          </button>
        </div>
        <div className="flex-1 overflow-auto p-2 space-y-2">
          {chapters.map((chapter) => {
            const isActive = chapter.id === activeChapterId;
            return (
              <div
                key={chapter.id}
                className={`border rounded-lg ${
                  isActive ? "border-dark bg-secondary" : "border-light"
                } transition-colors`}
              >
                <button
                  type="button"
                  onClick={() => setActiveChapterId(chapter.id)}
                  className="w-full text-left px-3 py-2"
                  title={chapter.title}
                >
                  <div className="text-sm text-primary truncate">{chapter.title}</div>
                  <div className="text-xs text-muted">ç‚¹å‡»è¿›å…¥å¹¶åœ¨å³ä¾§ç¼–è¾‘</div>
                </button>
                <div className="flex items-center justify-end gap-2 px-3 pb-2">
                  <button
                    type="button"
                    className="text-xs text-muted hover:text-primary transition-colors"
                    onClick={() => renameChapter(chapter)}
                  >
                    é‡å‘½å?                  </button>
                  <span className="text-muted">Â·</span>
                  <button
                    type="button"
                    className="text-xs text-muted hover:text-error transition-colors"
                    onClick={() => removeChapter(chapter)}
                  >
                    åˆ é™¤
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      </aside>

      <main className="flex-1 min-w-0 flex flex-col">
        <div className="sticky top-0 z-10 bg-primary/80 backdrop-blur-sm border-b border-light">
          <div className="flex items-center gap-2 px-4 py-3 overflow-x-auto">
            <span className="text-sm text-muted mr-2">æ ¼å¼</span>
            <div className="flex items-center gap-2">
              <button
                className={`toolbar-btn ${editor?.isActive("heading", { level: 1 }) ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleHeading({ level: 1 }).run()}
                disabled={!editor}
              >
                H1
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("heading", { level: 2 }) ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleHeading({ level: 2 }).run()}
                disabled={!editor}
              >
                H2
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("heading", { level: 3 }) ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleHeading({ level: 3 }).run()}
                disabled={!editor}
              >
                H3
              </button>
            </div>

            <span className="text-muted mx-1">|</span>

            <div className="flex items-center gap-2">
              <button
                className={`toolbar-btn ${editor?.isActive("bold") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleBold().run()}
                disabled={!editor?.can().chain().focus().toggleBold().run()}
              >
                B
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("italic") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleItalic().run()}
                disabled={!editor?.can().chain().focus().toggleItalic().run()}
              >
                <span className="italic">I</span>
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("strike") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleStrike().run()}
                disabled={!editor?.can().chain().focus().toggleStrike().run()}
              >
                <span className="line-through">S</span>
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("blockquote") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleBlockquote().run()}
              >
                â€?â€?              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("codeBlock") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleCodeBlock().run()}
              >
                {"</>"}
              </button>
            </div>

            <span className="text-muted mx-1">|</span>

            <div className="flex items-center gap-2">
              <button
                className={`toolbar-btn ${editor?.isActive("bulletList") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleBulletList().run()}
              >
                â€?åˆ—è¡¨
              </button>
              <button
                className={`toolbar-btn ${editor?.isActive("orderedList") ? "active" : ""}`}
                onClick={() => editor?.chain().focus().toggleOrderedList().run()}
              >
                1. åˆ—è¡¨
              </button>
            </div>

            <span className="text-muted mx-1">|</span>

            <div className="ml-auto flex items-center gap-2">
              <button
                className="btn-secondary px-3 py-2 text-sm"
                onClick={() => editor?.chain().focus().undo().run()}
                disabled={!editor?.can().chain().focus().undo().run()}
              >
                æ’¤é”€
              </button>
              <button
                className="btn-secondary px-3 py-2 text-sm"
                onClick={() => editor?.chain().focus().redo().run()}
                disabled={!editor?.can().chain().focus().redo().run()}
              >
                é‡åš
              </button>
              <button className="btn-primary px-3 py-2 text-sm" type="button">
                å·²è‡ªåŠ¨ä¿å­?              </button>
            </div>
          </div>
        </div>

        <div className="flex-1 overflow-auto">
          <div className="max-w-3xl mx-auto px-4 py-6">
            <div className="rounded-xl border border-light bg-secondary p-4">
              <EditorContent editor={editor} />
            </div>
          </div>
        </div>
      </main>

      <aside className="hidden lg:flex lg:w-80 xl:w-96 border-l border-light bg-primary flex-col">
        <div className="px-4 py-3 border-b border-light flex items-center justify-between">
          <span className="text-primary font-semibold">å†™ä½œåŠ©æ‰‹</span>
          <span className="text-muted text-sm">ä»?UI å±•ç¤º</span>
        </div>
        <div className="flex-1 overflow-auto p-4 space-y-3">
          {messages.map((message) => (
            <div
              key={message.id}
              className={`w-full flex ${message.role === "user" ? "justify-end" : "justify-start"}`}
            >
              <div
                className={`max-w-[80%] rounded-lg px-3 py-2 border ${
                  message.role === "user"
                    ? "bg-[var(--color-dark)] text-white border-[var(--color-dark)]"
                    : "bg-secondary border-light text-primary"
                }`}
              >
                <div className="whitespace-pre-wrap text-sm">{message.content}</div>
              </div>
            </div>
          ))}
        </div>
        <form onSubmit={onSend} className="border-t border-light p-3">
          <div className="flex items-center gap-2">
            <input
              className="form-input flex-1"
              placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€ï¼ˆä»?UIï¼?
              value={input}
              onChange={(event) => setInput(event.target.value)}
            />
            <button type="submit" className="btn-primary px-4 py-2 text-sm">
              å‘é€?            </button>
          </div>
        </form>
      </aside>
    </div>
  );
}

